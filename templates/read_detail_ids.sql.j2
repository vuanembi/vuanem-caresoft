SELECT
    s.`{{ detail_id }}` AS id
FROM
    `{{ dataset }}.{{ parent }}` s

    {% if with_ref -%}
    LEFT JOIN `{{ dataset }}.{{ table }}` d
    ON s.`{{ detail_id }}` = d.`{{ detail_id }}`
WHERE
    (
        (
            timestamp_trunc(
                timestamp_add(
                    s.`updated_at`,
                    INTERVAL 500 millisecond
                ),
                SECOND
            ) <> timestamp_trunc(
                timestamp_add(
                    d.`updated_at`,
                    INTERVAL 500 millisecond
                ),
                SECOND
            )
            AND timestamp_trunc(
                s.`updated_at`,
                SECOND
            ) <> timestamp_trunc(
                d.`updated_at`,
                SECOND
            )
        )
        OR d.updated_at IS NULL
    )
    AND s.{{ detail_id }} NOT IN (
        SELECT
            {{ detail_id }}
        FROM
            `{{ dataset }}._stage_Deleted{{ parent }}`
    )
{%- endif %}
LIMIT
    {{ limit }}
